(function(){var t,e={}.hasOwnProperty,n=function(t,n){function r(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return r.prototype=n.prototype,t.prototype=new r,t.__super__=n.prototype,t},r=[].slice;Backbone.TypeaheadCollection=function(e){function i(){return t=i.__super__.constructor.apply(this,arguments)}return n(i,e),i.prototype._tokenize=function(t){return t=$.trim(t),0===t.length?null:t.toLowerCase().split(/[\s\-_]+/)},i.prototype._tokenizeModel=function(t){if(null==this.typeaheadAttributes)throw new Error("Missing typeaheadAttributes value");return _.uniq(this._tokenize(_.flatten(_.map(this.typeaheadAttributes,function(e){return t.get(e)})).join(" ")))},i.prototype._addToIndex=function(t){var e,n,r,i,o,u,s,a,h;for(_.isArray(t)||(t=[t]),h=[],s=0,a=t.length;a>s;s++)i=t[s],u=this._tokenizeModel(i),r=null!=i.id?i.id:i.cid,this._tokens[r]=u,h.push(function(){var t,i,s,a;for(a=[],i=0,s=u.length;s>i;i++)o=u[i],n=o.charAt(0),e=(t=this._adjacency)[n]||(t[n]=[r]),~_.indexOf(e,r)?a.push(void 0):a.push(e.push(r));return a}.call(this));return h},i.prototype._removeFromIndex=function(t){var e,n,i,o,u,s,a,h;for(_.isArray(t)||(t=[t]),n=_.map(t,function(t){return null!=t.id?t.id:t.cid}),u=0,s=n.length;s>u;u++)e=n[u],delete this._tokens[e];a=this._adjacency,h=[];for(i in a)o=a[i],h.push(this._adjacency[i]=_.without.apply(_,[o].concat(r.call(n))));return h},i.prototype._rebuildIndex=function(){return this._adjacency={},this._tokens={},this._addToIndex(this.models)},i.prototype._facetMatch=function(t,e){var n,r;for(n in t)if(r=t[n],null!=r&&r!==e[n])return!1;return!0},i.prototype.typeaheadIndexer=function(t){return null!=t&&_.keys(t).length>0?_.map(this.where(t),function(t){return null!=t.id?t.id:t.cid}):null},i.prototype.typeahead=function(t,e){var n,r,i,o,u,s,a,h,l,p,c,d,y=this;if(null==this._adjacency)throw new Error("Index is not built");if(h=this._tokenize(t),p=[],a=[],l=null,r=_(h).chain().map(function(t){return t.charAt(0)}).uniq().value(),_.all(r,function(t){var e;return e=y._adjacency[t],null==e?!1:(a.push(e),e.length<((null!=l?l.length:void 0)||y.length)&&(l=e),!0)}),a.length<r.length)return[];if(n=this.typeaheadIndexer(e),null!=n&&a.push(n),null!=n&&n.length<((null!=l?l.length:void 0)||this.length)&&(l=n),null==l)return this.models;for(c=0,d=l.length;d>c;c++)i=l[c],o=_.every(a,function(t){return~_.indexOf(t,i)}),u=o&&_.every(h,function(t){return _.some(y._tokens[i],function(e){return 0===e.indexOf(t)})}),u&&(s=this.get(i),this.typeaheadPreserveOrder?p[this.indexOf(s)]=s:p.push(s));return this.typeaheadPreserveOrder?_.compact(p):p},i.prototype._reset=function(){return this._tokens={},this._adjacency={},i.__super__._reset.apply(this,arguments)},i.prototype.set=function(){var t;return t=i.__super__.set.apply(this,arguments),_.isArray(t)||(t=[t]),this._rebuildIndex(t),t},i.prototype.remove=function(){var t;return t=i.__super__.remove.apply(this,arguments),_.isArray(t)||(t=[t]),this._removeFromIndex(t),t},i.prototype._onModelEvent=function(t,e){var n;return n=!1,t==="change:"+e.idAttribute?(n=!0,this._removeFromIndex({id:e.previous(e.idAttribute)})):_.indexOf(_.map(this.typeaheadAttributes,function(t){return"change:"+t}),t)>=0&&(n=!0,this._removeFromIndex(e)),n&&this._addToIndex(e),i.__super__._onModelEvent.apply(this,arguments)},i}(Backbone.Collection)}).call(this);